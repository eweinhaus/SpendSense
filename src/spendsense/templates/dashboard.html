{% extends "base.html" %}

{% block title %}Dashboard - SpendSense{% endblock %}

{% block content %}
<h2 style="font-size: var(--font-size-3xl); font-weight: var(--font-weight-semibold); color: var(--color-neutral-900); margin-bottom: var(--spacing-6);">
    User Dashboard
</h2>

{% if stats %}
<!-- Quick Stats Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--spacing-4); margin-bottom: var(--spacing-8);">
    <!-- Total Users Card -->
    <div class="card" style="position: relative; padding: 12px; border: 1px solid var(--color-neutral-200);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
            <div style="font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-neutral-700); padding-left: var(--spacing-4);">
                Total Users
            </div>
            <div style="width: 36px; height: 36px; border-radius: 0.5rem; background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 7C16 9.20914 14.2091 11 12 11C9.79086 11 8 9.20914 8 7C8 4.79086 9.79086 3 12 3C14.2091 3 16 4.79086 16 7Z" fill="white"/>
                    <path d="M12 14C8.13401 14 5 17.134 5 21H19C19 17.134 15.866 14 12 14Z" fill="white"/>
                </svg>
            </div>
        </div>
        <div style="font-size: 3.5rem; font-weight: var(--font-weight-bold); color: var(--color-neutral-900); margin-bottom: 2px; line-height: 1; padding-left: var(--spacing-4);">
            {{ stats.total_users }}
        </div>
        <div style="font-size: var(--font-size-sm); color: var(--color-neutral-600); padding-left: var(--spacing-4);">
            Active users in system
        </div>
    </div>

    <!-- Personas Breakdown Card -->
    <div class="card" style="position: relative; padding: 12px; border: 1px solid var(--color-neutral-200);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
            <div style="font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-neutral-700); padding-left: var(--spacing-4);">
                Personas Distribution
            </div>
            <div style="width: 36px; height: 36px; border-radius: 0.5rem; background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4Z" fill="white"/>
                    <path d="M12 6C8.69 6 6 8.69 6 12C6 15.31 8.69 18 12 18C15.31 18 18 15.31 18 12C18 8.69 15.31 6 12 6Z" fill="white"/>
                    <path d="M12 8L16 12L12 16L8 12L12 8Z" fill="white" opacity="0.3"/>
                </svg>
            </div>
        </div>
        <div style="flex: 1; display: flex; align-items: center; justify-content: center; min-height: 80px; margin: 0;">
            <canvas id="personaChart" style="max-height: 80px; max-width: 100%;"></canvas>
        </div>
    </div>

    <!-- Consent Stats Card -->
    <div class="card" style="position: relative; padding: 12px; border: 1px solid var(--color-neutral-200);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
            <div style="font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-neutral-700); padding-left: var(--spacing-4);">
                Consent Status
            </div>
            <div style="width: 36px; height: 36px; border-radius: 0.5rem; background: linear-gradient(135deg, #10B981 0%, #059669 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z" fill="white"/>
                </svg>
            </div>
        </div>
        <div style="font-size: 3.5rem; font-weight: var(--font-weight-bold); color: var(--color-success); margin-bottom: 2px; line-height: 1; padding-left: var(--spacing-4);">
            {{ stats.users_with_consent }}
        </div>
        <div style="font-size: var(--font-size-sm); color: var(--color-neutral-600); margin-bottom: 2px; padding-left: var(--spacing-4);">
            With consent ({{ "%.0f"|format((stats.users_with_consent / stats.total_users * 100) if stats.total_users > 0 else 0) }}%)
        </div>
        <div style="font-size: var(--font-size-sm); color: var(--color-neutral-600); padding-left: var(--spacing-4);">
            {{ stats.users_without_consent }} without consent
        </div>
    </div>

    <!-- Recent Activity Card -->
    <div class="card" style="position: relative; padding: 12px; border: 1px solid var(--color-neutral-200);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
            <div style="font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-neutral-700); padding-left: var(--spacing-4);">
                Recent Activity
            </div>
            <div style="width: 36px; height: 36px; border-radius: 0.5rem; background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                    <path d="M12 6V12L16 14" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
        </div>
        <div style="font-size: 3.5rem; font-weight: var(--font-weight-bold); color: var(--color-neutral-900); margin-bottom: 2px; line-height: 1; padding-left: var(--spacing-4);">
            {{ stats.recent_users|length }}
        </div>
        <div style="font-size: var(--font-size-sm); color: var(--color-neutral-600); padding-left: var(--spacing-4);">
            Recent users added
        </div>
    </div>
</div>
{% endif %}

<!-- User List - Card Based Layout -->
{% if users %}
<div style="margin-bottom: var(--spacing-4);">
    <h3 style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-semibold); color: var(--color-neutral-900); margin-bottom: var(--spacing-4);">
        {% if current_search or current_persona_filter or current_utilization_min or current_utilization_max or current_subscription_min or current_subscription_max %}
            Filtered Users ({{ users|length }})
        {% else %}
            All Users
        {% endif %}
    </h3>
    
    <!-- Search and Filter Controls -->
    <div style="display: flex; flex-direction: column; gap: var(--spacing-4); margin-bottom: var(--spacing-6); padding: var(--spacing-4); background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
        <!-- Search and Filters Form -->
        <form method="get" action="/" id="search-form" style="display: flex; flex-direction: column; gap: var(--spacing-4);">
            <!-- Search Row -->
            <div style="display: flex; align-items: center; gap: var(--spacing-3);">
                <input 
                    type="text" 
                    id="user-search" 
                    name="search" 
                    value="{{ current_search }}"
                    placeholder="Search by name or email..."
                    class="form-input"
                    style="flex: 1; min-width: 200px; padding: var(--spacing-2) var(--spacing-4); font-size: var(--font-size-sm);"
                    autocomplete="off"
                >
                {% if current_search or current_persona_filter or current_utilization_min or current_utilization_max or current_subscription_min or current_subscription_max %}
                <a href="/" class="btn btn-secondary btn-sm">Clear</a>
                {% endif %}
                <button type="submit" class="btn btn-primary btn-sm">Search</button>
            </div>
            
            <!-- Filters Row -->
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: var(--spacing-4);">
                <!-- Persona Filter -->
                <div style="display: flex; flex-direction: column; gap: var(--spacing-1); min-width: 180px;">
                    <label for="persona-filter" style="font-size: var(--font-size-sm); color: var(--color-neutral-700); font-weight: var(--font-weight-medium);">
                        Persona
                    </label>
                    <select 
                        id="persona-filter" 
                        name="persona_filter" 
                        class="form-input"
                        style="padding: var(--spacing-2) var(--spacing-3); font-size: var(--font-size-sm);"
                    >
                        <option value="">All Personas</option>
                        <option value="high_utilization" {{ 'selected' if current_persona_filter == 'high_utilization' else '' }}>High Utilization</option>
                        <option value="variable_income_budgeter" {{ 'selected' if current_persona_filter == 'variable_income_budgeter' else '' }}>Variable Income</option>
                        <option value="savings_builder" {{ 'selected' if current_persona_filter == 'savings_builder' else '' }}>Savings Builder</option>
                        <option value="financial_newcomer" {{ 'selected' if current_persona_filter == 'financial_newcomer' else '' }}>Newcomer</option>
                        <option value="subscription_heavy" {{ 'selected' if current_persona_filter == 'subscription_heavy' else '' }}>Subscription-Heavy</option>
                        <option value="neutral" {{ 'selected' if current_persona_filter == 'neutral' else '' }}>Neutral</option>
                    </select>
                </div>
                
                <!-- Utilization Filter -->
                <div style="display: flex; flex-direction: column; gap: var(--spacing-1); min-width: 180px;">
                    <label for="utilization-filter" style="font-size: var(--font-size-sm); color: var(--color-neutral-700); font-weight: var(--font-weight-medium);">
                        Utilization (%)
                    </label>
                    <select 
                        id="utilization-filter" 
                        name="utilization_range" 
                        class="form-input"
                        style="padding: var(--spacing-2) var(--spacing-3); font-size: var(--font-size-sm);"
                    >
                        {% set util_range = '' %}
                        {% if current_utilization_min is not none and current_utilization_max is not none %}
                            {% set util_range = (current_utilization_min|string + '-' + current_utilization_max|string) %}
                        {% elif current_utilization_min is not none %}
                            {% set util_range = '' %}
                        {% endif %}
                        <option value="">All</option>
                        <option value="0-25" {{ 'selected' if util_range == '0-25' else '' }}>0-25%</option>
                        <option value="26-50" {{ 'selected' if util_range == '26-50' else '' }}>26-50%</option>
                        <option value="51-75" {{ 'selected' if util_range == '51-75' else '' }}>51-75%</option>
                        <option value="76-100" {{ 'selected' if util_range == '76-100' else '' }}>76-100%</option>
                        <option value="0-50" {{ 'selected' if util_range == '0-50' else '' }}>0-50%</option>
                        <option value="51-100" {{ 'selected' if util_range == '51-100' else '' }}>51-100%</option>
                    </select>
                    <input type="hidden" name="utilization_min" id="utilization-min-input" value="{{ current_utilization_min or '' }}">
                    <input type="hidden" name="utilization_max" id="utilization-max-input" value="{{ current_utilization_max or '' }}">
                </div>
                
                <!-- Subscriptions Filter -->
                <div style="display: flex; flex-direction: column; gap: var(--spacing-1); min-width: 180px;">
                    <label for="subscription-filter" style="font-size: var(--font-size-sm); color: var(--color-neutral-700); font-weight: var(--font-weight-medium);">
                        Subscriptions
                    </label>
                    <select 
                        id="subscription-filter" 
                        name="subscription_range" 
                        class="form-input"
                        style="padding: var(--spacing-2) var(--spacing-3); font-size: var(--font-size-sm);"
                    >
                        {% set sub_range = '' %}
                        {% if current_subscription_min is not none and current_subscription_max is not none %}
                            {% if current_subscription_min == 0 and current_subscription_max == 0 %}
                                {% set sub_range = '0' %}
                            {% else %}
                                {% set sub_range = (current_subscription_min|string + '-' + current_subscription_max|string) %}
                            {% endif %}
                        {% elif current_subscription_min is not none and current_subscription_min >= 11 %}
                            {% set sub_range = '11+' %}
                        {% endif %}
                        <option value="">All</option>
                        <option value="0" {{ 'selected' if sub_range == '0' else '' }}>0</option>
                        <option value="1-3" {{ 'selected' if sub_range == '1-3' else '' }}>1-3</option>
                        <option value="4-6" {{ 'selected' if sub_range == '4-6' else '' }}>4-6</option>
                        <option value="7-10" {{ 'selected' if sub_range == '7-10' else '' }}>7-10</option>
                        <option value="11+" {{ 'selected' if sub_range == '11+' else '' }}>11+</option>
                    </select>
                    <input type="hidden" name="subscription_min" id="subscription-min-input" value="{{ current_subscription_min or '' }}">
                    <input type="hidden" name="subscription_max" id="subscription-max-input" value="{{ current_subscription_max or '' }}">
                </div>
            </div>
            
            {% if current_search or current_persona_filter or current_utilization_min or current_utilization_max or current_subscription_min or current_subscription_max %}
            <div style="font-size: var(--font-size-sm); color: var(--color-neutral-600); padding: var(--spacing-2) var(--spacing-3); background: var(--color-neutral-50); border-radius: 0.375rem; white-space: nowrap;">
                {{ users|length }} result{{ 's' if users|length != 1 else '' }}
            </div>
            {% endif %}
        </form>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: var(--spacing-4);">
        {% for user in users %}
        <div class="card" style="cursor: pointer; transition: transform 0.2s ease;" onclick="window.location.href='/user/{{ user.id }}'">
            <div style="margin-bottom: var(--spacing-4);">
                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); color: var(--color-neutral-900); margin-bottom: var(--spacing-2); word-break: break-word;">
                    {{ user.name }}
                </div>
                <div style="font-size: var(--font-size-sm); color: var(--color-neutral-600); margin-bottom: var(--spacing-2); word-break: break-word;">
                    {{ user.email }}
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-2);">
                    {% if user.persona_type == 'high_utilization' %}
                        <span class="badge badge-persona badge-persona-high-utilization" style="font-size: 0.75rem; padding: var(--spacing-1) var(--spacing-2); white-space: nowrap;">High Utilization</span>
                    {% elif user.persona_type == 'variable_income_budgeter' %}
                        <span class="badge badge-persona badge-persona-variable-income" style="font-size: 0.75rem; padding: var(--spacing-1) var(--spacing-2); white-space: nowrap;">Variable Income</span>
                    {% elif user.persona_type == 'savings_builder' %}
                        <span class="badge badge-persona badge-persona-savings-builder" style="font-size: 0.75rem; padding: var(--spacing-1) var(--spacing-2); white-space: nowrap;">Savings Builder</span>
                    {% elif user.persona_type == 'financial_newcomer' %}
                        <span class="badge badge-persona badge-persona-financial-newcomer" style="font-size: 0.75rem; padding: var(--spacing-1) var(--spacing-2); white-space: nowrap;">Newcomer</span>
                    {% elif user.persona_type == 'subscription_heavy' %}
                        <span class="badge badge-persona badge-persona-subscription-heavy" style="font-size: 0.75rem; padding: var(--spacing-1) var(--spacing-2); white-space: nowrap;">Subscription-Heavy</span>
                    {% else %}
                        <span class="badge badge-persona badge-persona-neutral" style="font-size: 0.75rem; padding: var(--spacing-1) var(--spacing-2); white-space: nowrap;">Neutral</span>
                    {% endif %}
                </div>
            </div>
            
            <div style="display: flex; gap: var(--spacing-4); margin-bottom: var(--spacing-4);">
                <div style="flex: 1;">
                    <div style="font-size: var(--font-size-sm); color: var(--color-neutral-600); margin-bottom: var(--spacing-1);">
                        Utilization
                    </div>
                    <div style="font-size: var(--font-size-base); font-weight: var(--font-weight-medium); color: var(--color-neutral-900);">
                        {{ user.utilization }}
                    </div>
                </div>
                <div style="flex: 1;">
                    <div style="font-size: var(--font-size-sm); color: var(--color-neutral-600); margin-bottom: var(--spacing-1);">
                        Subscriptions
                    </div>
                    <div style="font-size: var(--font-size-base); font-weight: var(--font-weight-medium); color: var(--color-neutral-900);">
                        {{ user.subscription_count }}
                    </div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: var(--spacing-4); border-top: 1px solid var(--color-neutral-200);">
                <div>
                    {% if user.consent_given %}
                        <span class="badge badge-success">Consent Given</span>
                    {% else %}
                        <span class="badge badge-warning">No Consent</span>
                    {% endif %}
                </div>
                <a href="/user/{{ user.id }}" class="btn btn-primary btn-sm" onclick="event.stopPropagation();">
                    View Details
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="alert alert-info">
    {% if current_search or current_persona_filter or current_utilization_min or current_utilization_max or current_subscription_min or current_subscription_max %}
        No users found matching your search criteria.
        <a href="/" style="color: inherit; text-decoration: underline; margin-left: var(--spacing-2);">Clear filters</a>
    {% else %}
        No users found. Please generate demo data first.
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
    // Persona Distribution Chart
    {% if stats and stats.persona_counts %}
    const personaData = {{ stats.persona_counts|tojson }};
    const personaLabels = [];
    const personaValues = [];
    const personaColors = {
        'high_utilization': '#F97316',
        'variable_income_budgeter': '#F59E0B',
        'savings_builder': '#10B981',
        'financial_newcomer': '#3B82F6',
        'subscription_heavy': '#8B5CF6',
        'neutral': '#6B7280'
    };
    
    // Format persona type names
    const personaNameMap = {
        'high_utilization': 'High Utilization',
        'variable_income_budgeter': 'Variable Income',
        'savings_builder': 'Savings Builder',
        'financial_newcomer': 'Financial Newcomer',
        'subscription_heavy': 'Subscription-Heavy',
        'neutral': 'Neutral'
    };
    
    const backgroundColors = [];
    for (const [type, count] of Object.entries(personaData)) {
        personaLabels.push(personaNameMap[type] || type);
        personaValues.push(count);
        backgroundColors.push(personaColors[type] || personaColors['neutral']);
    }
    
    const ctx = document.getElementById('personaChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: personaLabels,
                datasets: [{
                    data: personaValues,
                    backgroundColor: backgroundColors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
    
    // Filter functionality
    document.addEventListener('DOMContentLoaded', function() {
        const searchForm = document.getElementById('search-form');
        const utilizationFilter = document.getElementById('utilization-filter');
        const subscriptionFilter = document.getElementById('subscription-filter');
        const utilizationMinInput = document.getElementById('utilization-min-input');
        const utilizationMaxInput = document.getElementById('utilization-max-input');
        const subscriptionMinInput = document.getElementById('subscription-min-input');
        const subscriptionMaxInput = document.getElementById('subscription-max-input');
        
        // Handle utilization range selection
        if (utilizationFilter && utilizationMinInput && utilizationMaxInput) {
            utilizationFilter.addEventListener('change', function() {
                const value = this.value;
                if (value === '') {
                    utilizationMinInput.value = '';
                    utilizationMaxInput.value = '';
                } else {
                    const [min, max] = value.split('-').map(v => parseInt(v));
                    utilizationMinInput.value = min;
                    utilizationMaxInput.value = max || '';
                }
            });
        }
        
        // Handle subscription range selection
        if (subscriptionFilter && subscriptionMinInput && subscriptionMaxInput) {
            subscriptionFilter.addEventListener('change', function() {
                const value = this.value;
                if (value === '') {
                    subscriptionMinInput.value = '';
                    subscriptionMaxInput.value = '';
                } else if (value === '11+') {
                    subscriptionMinInput.value = '11';
                    subscriptionMaxInput.value = '';
                } else if (value === '0') {
                    subscriptionMinInput.value = '0';
                    subscriptionMaxInput.value = '0';
                } else {
                    const [min, max] = value.split('-').map(v => parseInt(v));
                    subscriptionMinInput.value = min;
                    subscriptionMaxInput.value = max || '';
                }
            });
        }
        
        // Initialize range values on page load from hidden inputs
        if (utilizationMinInput && utilizationMaxInput) {
            const utilMin = utilizationMinInput.value;
            const utilMax = utilizationMaxInput.value;
            if (utilMin && utilMax) {
                const rangeValue = utilMin + '-' + utilMax;
                if (utilizationFilter) {
                    utilizationFilter.value = rangeValue;
                }
            }
        }
        if (subscriptionMinInput && subscriptionMaxInput) {
            const subMin = subscriptionMinInput.value;
            const subMax = subscriptionMaxInput.value;
            if (subMin && subscriptionFilter) {
                if (subMin === '11' && !subMax) {
                    subscriptionFilter.value = '11+';
                } else if (subMin === '0' && subMax === '0') {
                    subscriptionFilter.value = '0';
                } else if (subMin && subMax) {
                    subscriptionFilter.value = subMin + '-' + subMax;
                }
            }
        }
        
        // Handle Enter key in search input
        const searchInput = document.getElementById('user-search');
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchForm.submit();
                }
            });
        }
    });
</script>
<style>
    @media (max-width: 767px) {
        /* Stack cards vertically on mobile */
        .card {
            min-width: 100%;
        }
        
        div[style*="grid-template-columns"] {
            grid-template-columns: 1fr !important;
        }
    }
</style>
{% endblock %}
