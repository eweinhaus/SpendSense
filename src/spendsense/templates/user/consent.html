{% extends "user/base.html" %}

{% block title %}Consent Management - SpendSense{% endblock %}

{% block content %}
<h1 style="font-size: var(--font-size-3xl); font-weight: var(--font-weight-semibold); color: var(--color-neutral-900); margin-bottom: var(--spacing-6);">
    Consent Management
</h1>

{% if request.query_params.get('success') %}
<div class="alert alert-success" role="alert">
    <strong>Success!</strong> Your consent status has been updated.
</div>
{% endif %}

{% if error_message %}
<div class="alert alert-error" role="alert">
    {{ error_message }}
</div>
{% endif %}

<!-- Consent Status Display -->
<div style="margin-bottom: var(--spacing-6);">
    <div class="card">
        <div class="card-header">Current Consent Status</div>
        <div style="display: flex; align-items: center; gap: var(--spacing-4); flex-wrap: wrap;">
            {% if user.consent_given %}
                <span class="badge badge-success" style="font-size: var(--font-size-base);">Granted</span>
            {% else %}
                <span class="badge badge-error" style="font-size: var(--font-size-base);">Not Granted</span>
            {% endif %}
            <span style="font-size: var(--font-size-sm); color: var(--color-neutral-600);">
                Last updated: {{ user.created_at }}
            </span>
        </div>
    </div>
</div>

<!-- Consent Explanation -->
<div style="margin-bottom: var(--spacing-6);">
    <div class="card">
        <div class="card-header">What Consent Enables</div>
        <div>
            <p style="margin-bottom: var(--spacing-4);">When you grant consent, SpendSense can:</p>
            <ul style="margin-bottom: var(--spacing-4); padding-left: var(--spacing-6);">
                <li style="margin-bottom: var(--spacing-2);">
                    <strong>Detect behavioral signals</strong> from your transaction data (credit utilization, subscriptions, savings patterns, income stability)
                </li>
                <li style="margin-bottom: var(--spacing-2);">
                    <strong>Assign you a financial persona</strong> based on your patterns
                </li>
                <li style="margin-bottom: var(--spacing-2);">
                    <strong>Generate personalized recommendations</strong> tailored to your financial situation
                </li>
                <li style="margin-bottom: var(--spacing-2);">
                    <strong>Provide eligible partner offers</strong> that match your profile
                </li>
            </ul>
            <p style="margin: 0;">
                <strong>Without consent:</strong> You can still view your account information and use calculators, but you won't receive personalized recommendations or partner offers.
            </p>
        </div>
    </div>
</div>

<!-- Consent Toggle -->
<div style="margin-bottom: var(--spacing-6);">
    <div class="card">
        <div class="card-header">Update Consent</div>
        <div>
            <form method="post" action="/portal/consent" id="consentForm">
                <div class="form-group" style="margin-bottom: var(--spacing-4);">
                    <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
                        <input type="checkbox" id="consentToggle" name="consent" value="true" 
                               {% if user.consent_given %}checked{% endif %}
                               style="width: 20px; height: 20px; cursor: pointer;">
                        <strong>Grant consent for data processing and personalized recommendations</strong>
                    </label>
                </div>
                {% if user.consent_given %}
                <div class="alert alert-warning" id="revocationWarning" style="display: none;">
                    <strong>Warning:</strong> Revoking consent will remove all existing recommendations. 
                    This action cannot be undone.
                </div>
                {% endif %}
                <button type="submit" class="btn btn-primary">Update Consent</button>
            </form>
        </div>
    </div>
</div>

<!-- Revocation Impact -->
{% if user.consent_given %}
<div style="margin-bottom: var(--spacing-6);">
    <div class="card">
        <div class="card-header">If You Revoke Consent</div>
        <div>
            <p style="margin-bottom: var(--spacing-4);">If you revoke consent:</p>
            <ul style="padding-left: var(--spacing-6);">
                <li style="margin-bottom: var(--spacing-2);">All existing recommendations will be removed</li>
                <li style="margin-bottom: var(--spacing-2);">No new recommendations will be generated</li>
                <li style="margin-bottom: var(--spacing-2);">Partner offers will no longer be displayed</li>
                <li style="margin-bottom: var(--spacing-2);">You can still view your account data and use calculators</li>
                <li style="margin-bottom: var(--spacing-2);">You can grant consent again at any time to re-enable recommendations</li>
            </ul>
        </div>
    </div>
</div>
{% endif %}

<div style="margin-top: var(--spacing-6);">
    <a href="/portal/dashboard" class="btn btn-secondary">Back to Dashboard</a>
</div>

<script>
// Show warning when unchecking consent
document.getElementById('consentToggle').addEventListener('change', function() {
    const warning = document.getElementById('revocationWarning');
    if (warning) {
        if (!this.checked) {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    }
});
</script>
{% endblock %}
