{% extends "user/base.html" %}

{% block title %}Consent Management - SpendSense{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Consent Management</h1>
    </div>
</div>

{% if request.query_params.get('success') %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <strong>Success!</strong> Your consent status has been updated.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

{% if error_message %}
<div class="alert alert-danger" role="alert">
    {{ error_message }}
</div>
{% endif %}

<!-- Consent Status Display -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Current Consent Status</h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <span class="badge bg-{% if user.consent_given %}success{% else %}danger{% endif %} fs-6 me-3">
                        {% if user.consent_given %}Granted{% else %}Not Granted{% endif %}
                    </span>
                    <span class="text-muted">
                        Last updated: {{ user.created_at }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Consent Explanation -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">What Consent Enables</h5>
            </div>
            <div class="card-body">
                <p>When you grant consent, SpendSense can:</p>
                <ul>
                    <li><strong>Detect behavioral signals</strong> from your transaction data (credit utilization, subscriptions, savings patterns, income stability)</li>
                    <li><strong>Assign you a financial persona</strong> based on your patterns</li>
                    <li><strong>Generate personalized recommendations</strong> tailored to your financial situation</li>
                    <li><strong>Provide eligible partner offers</strong> that match your profile</li>
                </ul>
                <p class="mb-0"><strong>Without consent:</strong> You can still view your account information and use calculators, but you won't receive personalized recommendations or partner offers.</p>
            </div>
        </div>
    </div>
</div>

<!-- Consent Toggle -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Update Consent</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/portal/consent" id="consentForm">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="consentToggle" 
                               name="consent" value="true" {% if user.consent_given %}checked{% endif %}>
                        <label class="form-check-label" for="consentToggle">
                            <strong>Grant consent for data processing and personalized recommendations</strong>
                        </label>
                    </div>
                    {% if user.consent_given %}
                    <div class="alert alert-warning" id="revocationWarning" style="display: none;">
                        <strong>Warning:</strong> Revoking consent will remove all existing recommendations. 
                        This action cannot be undone.
                    </div>
                    {% endif %}
                    <button type="submit" class="btn btn-primary">Update Consent</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Revocation Impact -->
{% if user.consent_given %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">If You Revoke Consent</h5>
            </div>
            <div class="card-body">
                <p>If you revoke consent:</p>
                <ul>
                    <li>All existing recommendations will be removed</li>
                    <li>No new recommendations will be generated</li>
                    <li>Partner offers will no longer be displayed</li>
                    <li>You can still view your account data and use calculators</li>
                    <li>You can grant consent again at any time to re-enable recommendations</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="mt-4">
    <a href="/portal/dashboard" class="btn btn-outline-secondary">Back to Dashboard</a>
</div>

<script>
// Show warning when unchecking consent
document.getElementById('consentToggle').addEventListener('change', function() {
    const warning = document.getElementById('revocationWarning');
    if (warning) {
        if (!this.checked) {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    }
});
</script>
{% endblock %}

